name: "Build (& deploy) Docs"

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  UV_SYSTEM_PYTHON: 1

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.10"
          enable-cache: true

      - name: Install docs dependencies
        run: |
          uv pip install -r _requirements/_docs.txt
          uv pip install -e .

      - name: Build documentation
        working-directory: docs
        run: make html --jobs $(nproc)

      - name: Upload built docs
        uses: actions/upload-artifact@v4
        with:
          name: docs-html-${{ github.sha }}
          path: docs/build/html
          retention-days: 1

  docs-deploy:
    needs: build-docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5 # deploy needs git credentials

      - name: Download prepared docs
        uses: actions/download-artifact@v5
        with:
          name: docs-html-${{ github.sha }}
          path: docs/build/html

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4.7.3
        if: ${{ github.event_name == 'push' }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages # The branch the action should deploy to.
          folder: docs/build/html # The folder the action should deploy.
          clean: true # Automatically remove deleted files from the deploy branch
          target-folder: docs # If you'd like to push the contents of the deployment folder into a specific directory
          single-commit: true # you'd prefer to have a single commit on the deployment branch instead of full history
